{% extends "accounts/base.html" %}
{% block title %}Supervisor新增主机{% endblock %}

{% block breadcrumbs %}
<ul class="breadcrumb">
    <li>
        <i class="ace-icon fa fa-home home-icon"></i>
        <a href="{% url 'accounts:index' %}">系统首页</a>
    </li>
    <li>
        <a href="javascript: void (0);">Supervisor管理</a>
    </li>
    <li class="active">
        服务状态
    </li>
</ul><!-- /.breadcrumb -->
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>服务状态
        <small>
            <i class="ace-icon fa fa-angle-double-right"></i>
            Service Status
        </small>
    </h1>
</div>

<div class="row">
    {% for object in object_list %}
    <div class="col-xs-12 col-sm-6 widget-container-col ui-sortable"
         id="widget-container-col-2">

        <div class="widget-box widget-color-orange ui-sortable-handle"
             id="widget-box-3" style="opacity: 1;" slug="{{ object.slug }}">
            <div class="widget-header widget-header-small">
                <h6 class="widget-title">
                    <i class="ace-icon fa fa-sort"></i>
                    {{ object.host }}:{{object.port}}
                    <small class="text-danger">[最后刷新时间：]</small>
                </h6>

                <div class="widget-toolbar">
                    <a href="javascript: void(0);" data-action="settings">
                        <i class="ace-icon fa fa-cog"></i>
                    </a>

                    <a onclick="SupervisorReload('{{object.slug}}')"
                       data-action="reload">
                        <i class="ace-icon fa fa-refresh"></i>
                    </a>

                    <a href="javascript: void(0);" data-action="collapse">
                        <i class="ace-icon fa fa-minus"
                           data-icon-show="fa-plus"
                           data-icon-hide="fa-minus"></i>
                    </a>

                    <a href="javascript: void(0);" data-action="close">
                        <i class="ace-icon fa fa-times"></i>
                    </a>
                </div>
            </div>

            <div class="widget-body" style="">
                <div class="widget-main no-padding">
                    <table class="table table-striped table-bordered table-hover">
                        <thead class="thin-border-bottom">
                        <tr>
                            <th>
                                <i class="ace-icon fa fa-user"></i>
                                服务名称
                            </th>

                            <th>
                                <i>@</i>
                                描述
                            </th>
                            <th class="hidden-480">服务状态</th>
                            <th>操作</th>
                        </tr>
                        </thead>

                        <tbody>
                        <!--<tr>-->
                        <!--<td class="">Alex</td>-->

                        <!--<td class="hidden-480">-->
                        <!--<a href="javascript: void(0);">alex@email.com</a>-->
                        <!--</td>-->

                        <!--<td>-->
                        <!--<span class="label label-warning">Pending</span>-->
                        <!--</td>-->
                        <!--<td>-->
                        <!--<div class="hidden-sm hidden-xs btn-group">-->
                        <!--<a class="btn btn-xs btn-success"-->
                        <!--href="javascript: void(0);">-->
                        <!--<i class="ace-icon fa fa-refresh bigger-120"></i>-->
                        <!--</a>-->

                        <!--<a class="btn btn-xs btn-info"-->
                        <!--href="javascript: void(0);">-->
                        <!--<i class="ace-icon fa fa-pencil bigger-120"></i>-->
                        <!--</a>-->

                        <!--<a class="btn btn-xs btn-danger"-->
                        <!--href="javascript: void(0);">-->
                        <!--<i class="ace-icon fa fa-trash-o bigger-120"></i>-->
                        <!--</a>-->

                        <!--<button class="btn btn-xs btn-warning">-->
                        <!--<i class="ace-icon fa fa-flag bigger-120"></i>-->
                        <!--</button>-->
                        <!--</div>-->

                        <!--<div class="hidden-md hidden-lg">-->
                        <!--<div class="inline pos-rel">-->
                        <!--<button class="btn btn-minier btn-primary dropdown-toggle"-->
                        <!--data-toggle="dropdown"-->
                        <!--data-position="auto">-->
                        <!--<i class="ace-icon fa fa-cog icon-only bigger-110"></i>-->
                        <!--</button>-->

                        <!--<ul class="dropdown-menu dropdown-only-icon dropdown-yellow dropdown-menu-right dropdown-caret dropdown-close">-->

                        <!--<li>-->
                        <!--<a href="javascript: void(0);"-->
                        <!--class="tooltip-success"-->
                        <!--data-rel="tooltip"-->
                        <!--title="Edit">-->
                        <!--<span class="green">-->
                        <!--<i class="ace-icon fa fa-pencil-square-o bigger-120"></i>-->
                        <!--</span>-->
                        <!--</a>-->
                        <!--</li>-->

                        <!--<li>-->
                        <!--<a href="javascript: void(0);"-->
                        <!--class="tooltip-error"-->
                        <!--data-rel="tooltip"-->
                        <!--title="Delete">-->
                        <!--<span class="red">-->
                        <!--<i class="ace-icon fa fa-trash-o bigger-120"></i>-->
                        <!--</span>-->
                        <!--</a>-->
                        <!--</li>-->
                        <!--</ul>-->
                        <!--</div>-->
                        <!--</div>-->
                        <!--</td>-->
                        <!--</tr>-->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block otherjs %}
<script>
    $('#supervisor_manage').addClass('active open');
    $('#supervisor-service-status').addClass('active');

    function Supervisor(slug) {
        var result = "";
        $.ajax({
            url: "/accounts/supervisor/service/" + slug + "/status/",
            type: "get",
            dataType: "json",
            async: false,
            success: function (response_data) {
                result = response_data;
            }
        });
        return result;
    }

    function startApp(slug, app) {
        $(".widget-box[slug="+slug+"]").find("tr[name="+app+"]").find("td").eq(3).find("a").find("i").eq(0).attr("class",
            "ace-icon fa fa-spinner fa-spin bigger-120");
        $.ajax({
            url: "/accounts/supervisor/service/" + slug + "/start/?app=" + app,
            type: "get",
            dataType: "json",
            async: true,
            success: function (response_data) {
                if (response_data.status === 200) {
                    SupervisorReload(slug)
                } else {
                    $(".widget-box[slug="+slug+"]").find("tr[name="+app+"]").find("td").eq(3).find("a").find("i").eq(2).attr("class",
            "ace-icon fa fa-warning bigger-120");
                }
            }
        })
    }


    function stopApp(slug, app) {
        $(".widget-box[slug="+slug+"]").find("tr[name="+app+"]").find("td").eq(3).find("a").find("i").eq(0).attr("class",
            "ace-icon fa fa-spinner fa-spin bigger-120");
        $.ajax({
            url: "/accounts/supervisor/service/" + slug + "/stop/?app=" + app,
            type: "get",
            dataType: "json",
            async: true,
            success: function (response_data) {
                if (response_data.status === 200) {
                    SupervisorReload(slug)
                } else {
                    $(".widget-box[slug="+slug+"]").find("tr[name="+app+"]").find("td").eq(3).find("a").find("i").eq(2).attr("class",
            "ace-icon fa fa-warning bigger-120");
                }
            }
        })
    }

    function clearlogApp(slug, app) {
        $(".widget-box[slug="+slug+"]").find("tr[name="+app+"]").find("td").eq(3).find("a").find("i").eq(2).attr("class",
            "ace-icon fa fa-spinner fa-spin bigger-120");
        $.ajax({
            url: "/accounts/supervisor/service/" + slug + "/clearlog/?app=" + app,
            type: "get",
            dataType: "json",
            async: true,
            success: function (response_data) {
                if (response_data.status === 200) {
                    SupervisorReload(slug)
                } else {
                    $(".widget-box[slug="+slug+"]").find("tr[name="+app+"]").find("td").eq(3).find("a").find("i").eq(2).attr("class",
            "ace-icon fa fa-warning bigger-120");
                }
            }
        })
    }


    function Tbody(slug, tbody, item) {
        $(tbody).find('tr[name="' + item.name + '"]').find("td").eq(0).html('<a target="_blank" href="/accounts/supervisor/service/' + slug + '/tail/?app='+ item.name + '">' + item.name + '</a>');
        $(tbody).find('tr[name="' + item.name + '"]').find("td").eq(1).html(item.description);
        var status = $(tbody).find('tr[name="' + item.name + '"]').find("td").eq(2).find('span');
        var actions =
            $(tbody).find('tr[name="' + item.name + '"]').find("td").eq(3).find("a");
        if (item.status === "running") {
            status.attr("class", "label label-success arrowed-in arrowed-in-right");
            status.html("运行中");
            actions.eq(0).attr({
                "class": "btn btn-xs btn-danger",
                "title": "停止服务",
                "onclick": "stopApp('" + slug + "', '" + item.name + "')"
            });
            actions.eq(0).find("i").attr("class", "ace-icon fa fa-stop bigger-120");
        } else if (item.status === "stopped") {
            status.attr("class", "label label-danger arrowed-in arrowed-in-right");
            status.html("已停止");
            actions.eq(0).attr({
                "class": "btn btn-xs btn-success",
                "title": "启动服务",
                "onclick": "startApp('" + slug + "', '" + item.name + "')"
            });
            actions.eq(0).find("i").attr("class", "ace-icon fa fa-play bigger-120");

        } else if (item.status === "starting") {
            status.attr("class", "label label-info arrowed-in arrowed-in-right");
            status.html("正在启动");
        }

        actions.eq(2).attr({
            "onclick": "clearlogApp('" + slug + "', '" + item.name + "')"
        });
        actions.eq(2).find("i").attr("class", "ace-icon fa fa-trash-o bigger-120");
    }


    function SupervisorReload(slug) {
        var res = Supervisor(slug);
        $(".widget-box[slug='" + slug + "']").find("small").html("[最后刷新时间: " + get_now() + "]");
        if (res === "") {
            $(".widget-box[slug='" + slug + "']").find("table").hide();
        } else {
            var tbody = $(".widget-box[slug='" + slug + "']").find("tbody");
//            console.log(tbody)
            for (var index in res) {
                var item = res[index];
                Tbody(slug, tbody, item)
            }
        }
    }


    $(".widget-box").each(function () {
        var slug = $(this).attr("slug");
        var res = Supervisor(slug);
        $(this).find("small").html("[最后刷新时间: " + get_now() + "]");
        if (res === "") {
            $(this).find("table").hide();
        } else {
            var tbody = $(this).find("tbody");
            for (var index in res) {
                var item = res[index];
                tbody.append(
                    '<tr name="' + item.name + '"><td class="">Alex</td><td class="hidden-480"><a href="javascript: void(0);">alex@email.com</a></td><td><span class="label label-warning">Pending</span></td><td><div class="hidden-sm hidden-xs btn-group"><a class="btn btn-xs btn-success" href="javascript: void(0);"><i class="ace-icon fa fa-play bigger-120"></i></a><a class="btn btn-xs btn-info" href="javascript: void(0);" title="Tail -f"><i class="ace-icon fa fa-file-o bigger-120"></i></a><a class="btn btn-xs btn-warning" href="javascript: void(0);" title="清空日志"><i class="ace-icon fa fa-trash-o bigger-120"></i></a></div><div class="hidden-md hidden-lg"><div class="inline pos-rel"><button class="btn btn-minier btn-primary dropdown-toggle" data-toggle="dropdown" data-position="auto"><i class="ace-icon fa fa-cog icon-only bigger-110"></i></button><ul class="dropdown-menu dropdown-only-icon dropdown-yellow dropdown-menu-right dropdown-caret dropdown-close"><li><a href="javascript: void(0);" class="tooltip-success" data-rel="tooltip" title="Edit"><span class="green"><i class="ace-icon fa fa-pencil-square-o bigger-120"></i></span></a></li><li><a href="javascript: void(0);" class="tooltip-error" data-rel="tooltip" title="Delete"><span class="red"><i class="ace-icon fa fa-trash-o bigger-120"></i></span></a></li></ul></div></div></td></tr>');
                Tbody(slug, tbody, item);

            }
        }
//        console.log(JSON.stringify(res));
    });

    function p(s) {
        return s < 10 ? '0' + s : s;
    }

    function get_now() {
        var myDate = new Date();
        //获取当前年
        var year = myDate.getFullYear();
        //获取当前月
        var month = myDate.getMonth() + 1;
        //获取当前日
        var date = myDate.getDate();
        var h = myDate.getHours();       //获取当前小时数(0-23)
        var m = myDate.getMinutes();     //获取当前分钟数(0-59)
        var s = myDate.getSeconds();

        var now = year + '-' + p(month) + "-" + p(date) + " " + p(h) + ':' + p(m) + ":" + p(s);
        return now
    }


</script>
{%endblock%}